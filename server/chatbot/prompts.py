"""
Промпты для виртуального ассистента музея.
"""

SYSTEM_PROMPT = """Ты - цифровой гид по Музею вычислительной техники ИрНИТУ. Твоя задача - помогать посетителям музея узнать об экспонатах, исторических личностях, залах музея и экскурсиях.

Твои возможности:
1. Рассказывать об экспонатах музея (название, описание, год создания, категория, зал)
2. Рассказывать об исторических личностях, связанных с экспонатами
3. Рекомендовать экспонаты по запросам посетителей
4. Отвечать на вопросы о музее, его истории и коллекции

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:
- ВСЕГДА используй ТОЛЬКО информацию из КОНТЕКСТА ниже. НИКОГДА не выдумывай данные, имена, даты или факты
- Если в контексте указано имя "Алексей Сергеевич Говорков", используй ТОЧНО это имя, а не "Александр Михайлович" или другие варианты
- Используй ТОЛЬКО те данные, которые указаны в контексте: имена, даты, описания, биографии
- Если какой-то информации нет в контексте, скажи об этом честно, но НЕ выдумывай данные
- Всегда отвечай на русском языке
- Будь дружелюбным и профессиональным
- ДАВАЙ ПОЛНЫЕ И РАЗВЕРНУТЫЕ ОТВЕТЫ на основе данных из контекста
- Если в контексте есть релевантные экспонаты или исторические личности, ОБЯЗАТЕЛЬНО упоминай их с описанием и ВСЕГДА предоставляй ссылки в формате Markdown
- Используй формат Markdown для форматирования ответов
- Если пользователь спрашивает об экспонате, исторической личности или зале, ОБЯЗАТЕЛЬНО включи ссылку в формате: [Полное название](/ссылка) прямо в тексте ответа
- ВСЕГДА включай ссылки на упомянутые объекты из контекста в свой ответ
- НИКОГДА не отвечай просто списком имен без описаний и контекста
- Когда упоминаешь экспонат или личность из контекста, сразу добавляй ссылку: например, "[Говорков Алексей Сергеевич](/historical_figures/6) - это..."

Формат ссылок:
- Экспонат: /artifacts/{id}
- Историческая личность: /historical_figures/{id}
- Зал: /halls/{id}

Пример хорошего ответа:
"В нашем музее представлено несколько интересных экспонатов. Например, [Acer 386](/artifacts/1) - это персональный компьютер, созданный в 1986 году. Он был одним из первых ПК с процессором Intel 80386..."

Пример плохого ответа (НЕ ДЕЛАЙ ТАК):
"Acer 386
Acer 486
CD-ROM"
"""

def get_chat_prompt(context: str = "") -> str:
    """
    Формирует промпт для чата с учетом контекста.
    
    Args:
        context: Контекстная информация об экспонатах, личностях и т.д.
    
    Returns:
        Форматированный промпт для LLM
    """
    prompt = SYSTEM_PROMPT
    
    if context:
        prompt += f"""

КОНТЕКСТ (релевантная информация из базы данных музея):
{context}

КРИТИЧЕСКИ ВАЖНО: Используй ТОЛЬКО информацию из этого контекста. НЕ выдумывай данные, имена, даты или факты. Если в контексте указано конкретное имя (например, "Алексей Сергеевич Говорков"), используй ТОЧНО это имя. Если в контексте указаны конкретные даты, описания или биография, используй ТОЛЬКО эти данные. Если какой-то информации нет в контексте, скажи об этом честно, но НЕ придумывай свои данные.

Если в контексте есть экспонаты или исторические личности, обязательно предоставляй ссылки на них в формате: [Полное название](/ссылка), где ссылка указана в контексте.
"""
    
    return prompt


def format_artifact_context(artifacts: list) -> str:
    """
    Форматирует список экспонатов для контекста промпта.
    
    Args:
        artifacts: Список словарей с информацией об экспонатах
    
    Returns:
        Форматированная строка с информацией об экспонатах
    """
    if not artifacts:
        return ""
    
    lines = ["\n=== ЭКСПОНАТЫ ==="]
    for artifact in artifacts:
        name = artifact.get('name', 'Неизвестно')
        lines.append(f"\n• НАЗВАНИЕ: {name}")
        lines.append(f"  ID: {artifact.get('id')}")
        
        if artifact.get('description'):
            desc = artifact.get('description', '')
            if len(desc) > 500:
                lines.append(f"  ОПИСАНИЕ: {desc[:500]}...")
            else:
                lines.append(f"  ОПИСАНИЕ: {desc}")
        
        if artifact.get('creation_year'):
            lines.append(f"  ГОД СОЗДАНИЯ: {artifact.get('creation_year')}")
        
        if artifact.get('category'):
            lines.append(f"  КАТЕГОРИЯ: {artifact.get('category', {}).get('name', 'Неизвестно')}")
        
        if artifact.get('hall'):
            lines.append(f"  ЗАЛ: {artifact.get('hall', {}).get('name', 'Неизвестно')}")
        
        lines.append(f"  ССЫЛКА ДЛЯ ОТВЕТА: [\"{name}\"](/artifacts/{artifact.get('id')})")
        lines.append("")
    
    return "\n".join(lines)


def format_historical_figure_context(figures: list) -> str:
    """
    Форматирует список исторических личностей для контекста промпта.
    
    Args:
        figures: Список словарей с информацией о личностях
    
    Returns:
        Форматированная строка с информацией о личностях
    """
    if not figures:
        return ""
    
    lines = ["\n=== ИСТОРИЧЕСКИЕ ЛИЧНОСТИ ==="]
    for figure in figures:
        full_name = f"{figure.get('last_name', '')} {figure.get('first_name', '')} {figure.get('middle_name', '')}".strip()
        lines.append(f"\n• ПОЛНОЕ ИМЯ: {full_name}")
        lines.append(f"  ID: {figure.get('id')}")
        
        # Добавляем все доступные данные
        if figure.get('description'):
            lines.append(f"  КРАТКОЕ ОПИСАНИЕ: {figure.get('description')}")
        
        if figure.get('biography'):
            # Используем полную биографию, но ограничиваем длину для контекста
            biography = figure.get('biography', '')
            if len(biography) > 1000:
                lines.append(f"  БИОГРАФИЯ: {biography[:1000]}...")
            else:
                lines.append(f"  БИОГРАФИЯ: {biography}")
        
        if figure.get('birth_date'):
            lines.append(f"  ДАТА РОЖДЕНИЯ: {figure.get('birth_date')}")
        
        if figure.get('death_date'):
            lines.append(f"  ДАТА СМЕРТИ: {figure.get('death_date')}")
        
        if figure.get('science_fields'):
            fields = [field.get('name', '') for field in figure.get('science_fields', []) if field.get('name')]
            if fields:
                lines.append(f"  ОБЛАСТИ НАУКИ: {', '.join(fields)}")
        
        lines.append(f"  ССЫЛКА ДЛЯ ОТВЕТА: [\"{full_name}\"](/historical_figures/{figure.get('id')})")
        lines.append("")
    
    return "\n".join(lines)
